{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}Register - Car Wash{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center py-4 py-lg-5">
        <div class="col-md-8 col-lg-6 px-4 ">
            <div class="text-center mb-4">
                <div class="rounded-circle bg-primary bg-gradient d-inline-flex align-items-center justify-content-center"
                    style="width:64px;height:64px;">
                    <i class="fa-solid fa-user-plus text-white"></i>
                </div>
                <h2 class="mt-3 mb-1 fw-bold">Create your account</h2>
                <p class="text-muted">A few details to get you started</p>
            </div>
            <div class="card p-4 p-lg-5">
                {% if form.errors %}
                <div class="alert alert-danger">
                    {% for field, errors in form.errors.items %}
                    <strong>{{ field|title }}:</strong>
                    {% for error in errors %}
                    {{ error }}<br>
                    {% endfor %}
                    {% endfor %}
                </div>
                {% endif %}

                <form method="post" autocomplete="off" novalidate>
                    {% csrf_token %}
                    <div class="row g-3 mb-2">
                        <div class="col-md-6">
                            <label class="form-label">First Name</label>
                            {{ form.first_name|add_class:"form-control" }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Last Name</label>
                            {{ form.last_name|add_class:"form-control" }}
                        </div>
                    </div>
                    <div class="row g-3 mb-2">
                        <div class="col-md-6">
                            <label class="form-label">Username</label>
                            {{ form.username|add_class:"form-control" }}
                            <div id="username-feedback" class="form-text"></div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            {{ form.email|add_class:"form-control" }}
                            <div id="email-feedback" class="form-text"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mobile Number</label>
                        {{ form.mobile|add_class:"form-control" }}
                    </div>
                    <div class="row g-3 mb-2">
                        <div class="col-md-6">
                            <label class="form-label">Password</label>
                            {{ form.password1|add_class:"form-control" }}
                            <div id="password1-feedback" class="form-text"></div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Confirm Password</label>
                            {{ form.password2|add_class:"form-control" }}
                            <div id="password2-feedback" class="form-text"></div>
                        </div>
                    </div>
                    <div class="d-grid gap-2 mt-3">
                        <button type="submit" class="btn btn-accent" id="submit-btn">Create account</button>
                    </div>
                    <div class="mt-2 d-flex justify-content-end">
                        <a href="{% url 'login' %}" class="link-secondary">Already have an account?</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
    let usernameTimeout, emailTimeout;
    let usernameAvailable = false, emailAvailable = false, passwordsMatch = false;

    document.getElementById('id_username').addEventListener('input', function () {
        clearTimeout(usernameTimeout);
        const username = this.value.trim();
        const feedback = document.getElementById('username-feedback');

        if (!username) {
            feedback.innerHTML = '';
            usernameAvailable = false;
            updateSubmitButton();
            return;
        }

        feedback.innerHTML = '<span class="text-muted">Checking...</span>';

        usernameTimeout = setTimeout(() => {
            fetch(`/api/check-username/?username=${encodeURIComponent(username)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.available) {
                        feedback.innerHTML = '<span class="text-success">✓ Username available</span>';
                        usernameAvailable = true;
                    } else {
                        feedback.innerHTML = '<span class="text-danger">✗ Username already taken</span>';
                        usernameAvailable = false;
                    }
                    updateSubmitButton();
                });
        }, 500);
    });

    document.getElementById('id_email').addEventListener('input', function () {
        clearTimeout(emailTimeout);
        const email = this.value.trim();
        const feedback = document.getElementById('email-feedback');

        if (!email) {
            feedback.innerHTML = '';
            emailAvailable = false;
            updateSubmitButton();
            return;
        }

        feedback.innerHTML = '<span class="text-muted">Checking...</span>';

        emailTimeout = setTimeout(() => {
            fetch(`/api/check-email/?email=${encodeURIComponent(email)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.available) {
                        feedback.innerHTML = '<span class="text-success">✓ Email available</span>';
                        emailAvailable = true;
                    } else {
                        feedback.innerHTML = '<span class="text-danger">✗ Email already registered</span>';
                        emailAvailable = false;
                    }
                    updateSubmitButton();
                });
        }, 500);
    });

    function checkPasswordMatch() {
        const password1 = document.getElementById('id_password1').value;
        const password2 = document.getElementById('id_password2').value;
        const feedback = document.getElementById('password2-feedback');

        if (!password2) {
            feedback.innerHTML = '';
            passwordsMatch = false;
            updateSubmitButton();
            return;
        }

        if (password1 === password2) {
            feedback.innerHTML = '<span class="text-success">✓ Passwords match</span>';
            passwordsMatch = true;
        } else {
            feedback.innerHTML = '<span class="text-danger">✗ Passwords do not match</span>';
            passwordsMatch = false;
        }
        updateSubmitButton();
    }

    document.getElementById('id_password1').addEventListener('input', checkPasswordMatch);
    document.getElementById('id_password2').addEventListener('input', checkPasswordMatch);

    function updateSubmitButton() {
        const submitBtn = document.getElementById('submit-btn');
        const firstName = document.getElementById('id_first_name').value.trim();
        const lastName = document.getElementById('id_last_name').value.trim();
        const username = document.getElementById('id_username').value.trim();
        const email = document.getElementById('id_email').value.trim();
        const mobile = document.getElementById('id_mobile').value.trim();
        const password1 = document.getElementById('id_password1').value;
        const password2 = document.getElementById('id_password2').value;

        if (firstName && lastName && username && email && mobile && password1 && password2 && usernameAvailable && emailAvailable && passwordsMatch) {
            submitBtn.disabled = false;
        } else {
            submitBtn.disabled = true;
        }
    }
</script>
{% endblock %}